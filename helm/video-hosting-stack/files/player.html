<!DOCTYPE html>
<html>
<head>
  <title>HLS Player with Quality Selector</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #player-container {
      margin: 20px 0;
    }
    .controls {
      margin: 15px 0;
    }
    #quality-selector {
      margin-top: 10px;
      padding: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>HLS Player with Quality Selection</h1>
  
  <div id="player-container">
    <video id="player" playsinline controls></video>
  </div>
  
  <div class="controls">
    <input type="text" id="url-input" placeholder="Enter HLS URL" style="width: 70%; padding: 8px;">
    <button id="load-btn">Load Video</button>
    <select id="quality-selector">
      <option value="auto">Auto quality</option>
    </select>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <script>
    // Инициализация элементов
    const playerElement = document.getElementById('player');
    const player = new Plyr(playerElement);
    const urlInput = document.getElementById('url-input');
    const loadBtn = document.getElementById('load-btn');
    const qualitySelector = document.getElementById('quality-selector');
    
    let hls = null;
    let qualityLevels = [];

    // Загрузка видео
    loadBtn.addEventListener('click', loadVideo);
    qualitySelector.addEventListener('change', changeQuality);

    function loadVideo() {
      const url = urlInput.value.trim();
      if (!url) return alert('Please enter a valid URL');
      
      // Очистка предыдущего плеера
      if (hls) {
        hls.destroy();
        qualitySelector.style.display = 'none';
      }
      
      // Инициализация HLS
      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(playerElement);
        
        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          qualityLevels = data.levels;
          updateQualitySelector();
          player.play().catch(e => console.log('Autoplay prevented:', e));
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error('HLS error:', data);
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                console.error('Unrecoverable error');
            }
          }
        });
        
      } else if (playerElement.canPlayType('application/vnd.apple.mpegurl')) {
        // Для Safari
        playerElement.src = url;
        playerElement.addEventListener('loadedmetadata', () => {
          player.play().catch(e => console.log('Autoplay prevented:', e));
        });
      } else {
        alert('HLS is not supported in your browser');
      }
    }

    // Обновление списка качеств
    function updateQualitySelector() {
      qualitySelector.innerHTML = '<option value="auto">Auto quality</option>';
      
      if (qualityLevels && qualityLevels.length > 1) {
        qualityLevels.forEach((level, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.text = `${level.height}p (${Math.round(level.bitrate/1000)}kbps)`;
          qualitySelector.appendChild(option);
        });
        qualitySelector.style.display = 'block';
      }
    }

    // Изменение качества
    function changeQuality() {
      if (!hls) return;
      
      const quality = qualitySelector.value;
      if (quality === 'auto') {
        hls.currentLevel = -1; // Автовыбор
      } else {
        hls.currentLevel = parseInt(quality);
      }
    }

    // Автозагрузка тестового потока
    urlInput.value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
  </script>
</body>
</html>